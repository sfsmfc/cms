/*! For license information please see MatrixInput.js.LICENSE.txt */
!function(){function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return n(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var i=0,a=function(){};return{s:a,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,l=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return s=t.done,t},e:function(t){l=!0,o=t},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw o}}}}function n(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function r(e,n,r){var i;return i=function(e,n){if("object"!=t(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,"string");if("object"!=t(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(n),(n="symbol"==t(i)?i:String(i))in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function i(){"use strict";i=function(){return n};var e,n={},r=Object.prototype,a=r.hasOwnProperty,o=Object.defineProperty||function(t,e,n){t[e]=n.value},s="function"==typeof Symbol?Symbol:{},l=s.iterator||"@@iterator",d=s.asyncIterator||"@@asyncIterator",c=s.toStringTag||"@@toStringTag";function u(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(e){u=function(t,e,n){return t[e]=n}}function h(t,e,n,r){var i=e&&e.prototype instanceof b?e:b,a=Object.create(i.prototype),s=new L(r||[]);return o(a,"_invoke",{value:T(t,n,s)}),a}function f(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}n.wrap=h;var p="suspendedStart",y="suspendedYield",m="executing",v="completed",g={};function b(){}function $(){}function E(){}var C={};u(C,l,(function(){return this}));var x=Object.getPrototypeOf,w=x&&x(x(O([])));w&&w!==r&&a.call(w,l)&&(C=w);var I=E.prototype=b.prototype=Object.create(C);function S(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function M(e,n){function r(i,o,s,l){var d=f(e[i],e,o);if("throw"!==d.type){var c=d.arg,u=c.value;return u&&"object"==t(u)&&a.call(u,"__await")?n.resolve(u.__await).then((function(t){r("next",t,s,l)}),(function(t){r("throw",t,s,l)})):n.resolve(u).then((function(t){c.value=t,s(c)}),(function(t){return r("throw",t,s,l)}))}l(d.arg)}var i;o(this,"_invoke",{value:function(t,e){function a(){return new n((function(n,i){r(t,e,n,i)}))}return i=i?i.then(a,a):a()}})}function T(t,n,r){var i=p;return function(a,o){if(i===m)throw new Error("Generator is already running");if(i===v){if("throw"===a)throw o;return{value:e,done:!0}}for(r.method=a,r.arg=o;;){var s=r.delegate;if(s){var l=k(s,r);if(l){if(l===g)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===p)throw i=v,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=m;var d=f(t,n,r);if("normal"===d.type){if(i=r.done?v:y,d.arg===g)continue;return{value:d.arg,done:r.done}}"throw"===d.type&&(i=v,r.method="throw",r.arg=d.arg)}}}function k(t,n){var r=n.method,i=t.iterator[r];if(i===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,k(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var a=f(i,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,g;var o=a.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function B(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function A(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(B,this),this.reset(!0)}function O(n){if(n||""===n){var r=n[l];if(r)return r.call(n);if("function"==typeof n.next)return n;if(!isNaN(n.length)){var i=-1,o=function t(){for(;++i<n.length;)if(a.call(n,i))return t.value=n[i],t.done=!1,t;return t.value=e,t.done=!0,t};return o.next=o}}throw new TypeError(t(n)+" is not iterable")}return $.prototype=E,o(I,"constructor",{value:E,configurable:!0}),o(E,"constructor",{value:$,configurable:!0}),$.displayName=u(E,c,"GeneratorFunction"),n.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===$||"GeneratorFunction"===(e.displayName||e.name))},n.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,E):(t.__proto__=E,u(t,c,"GeneratorFunction")),t.prototype=Object.create(I),t},n.awrap=function(t){return{__await:t}},S(M.prototype),u(M.prototype,d,(function(){return this})),n.AsyncIterator=M,n.async=function(t,e,r,i,a){void 0===a&&(a=Promise);var o=new M(h(t,e,r,i),a);return n.isGeneratorFunction(e)?o:o.next().then((function(t){return t.done?t.value:o.next()}))},S(I),u(I,c,"Generator"),u(I,l,(function(){return this})),u(I,"toString",(function(){return"[object Generator]"})),n.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},n.values=O,L.prototype={constructor:L,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(A),!t)for(var n in this)"t"===n.charAt(0)&&a.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(r,i){return s.type="throw",s.arg=t,n.next=r,i&&(n.method="next",n.arg=e),!!i}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],s=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var l=a.call(o,"catchLoc"),d=a.call(o,"finallyLoc");if(l&&d){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(l){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!d)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&a.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=e,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(o)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),g},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),A(n),g}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var i=r.arg;A(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:O(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},n}function a(t,e,n,r,i,a,o){try{var s=t[a](o),l=s.value}catch(t){return void n(t)}s.done?e(l):Promise.resolve(l).then(r,i)}function o(t){return function(){var e=this,n=arguments;return new Promise((function(r,i){var o=t.apply(e,n);function s(t){a(o,r,i,s,l,"next",t)}function l(t){a(o,r,i,s,l,"throw",t)}s(void 0)}))}}var s;s=jQuery,Craft.MatrixInput=Garnish.Base.extend({id:null,entryTypes:null,entryTypesByHandle:null,inputNamePrefix:null,inputIdPrefix:null,showingAddEntryMenu:!1,addEntryBtnGroupWidth:null,addEntryBtnContainerWidth:null,$container:null,$form:null,$entriesContainer:null,$addEntryBtnContainer:null,$addEntryBtn:null,$addEntryMenuBtn:null,$statusMessage:null,entrySort:null,entrySelect:null,elementEditor:null,addingEntry:!1,init:function(t,e,n,r){var a=this;this.id=t,this.entryTypes=e,this.inputNamePrefix=n,this.inputIdPrefix=Craft.formatInputId(this.inputNamePrefix),"number"==typeof r&&(r={maxEntries:r}),this.setSettings(r,Craft.MatrixInput.defaults),this.$container=s("#"+this.id),this.$form=this.$container.closest("form"),this.$entriesContainer=this.$container.children(".blocks"),this.$addEntryBtnContainer=this.$container.children(".buttons"),this.$addEntryBtn=this.$addEntryBtnContainer.children(".btn:not(.menubtn)"),this.$addEntryMenuBtn=this.$addEntryBtnContainer.children(".menubtn"),this.$statusMessage=this.$container.find("[data-status-message]"),this.$container.data("matrix",this),this.entryTypesByHandle={};for(var l=0;l<this.entryTypes.length;l++){var d=this.entryTypes[l];this.entryTypesByHandle[d.handle]=d}var c=this.$entriesContainer.children(".matrixblock"),u=Craft.MatrixInput.getCollapsedEntryIds();this.entrySort=new Garnish.DragSort(c,{handle:"> .actions > .move",axis:"y",filter:function(){return a.entrySort.$targetItem.hasClass("sel")?a.entrySelect.getSelectedItems():a.entrySort.$targetItem},collapseDraggees:!0,magnetStrength:4,helperLagBase:1.5,helperOpacity:.9,onDragStop:function(){a.trigger("entrySortDragStop")},onSortChange:function(){a.entrySelect.resetItemOrder()}}),this.entrySelect=new Garnish.Select(this.$entriesContainer,c,{multi:!0,vertical:!0,handle:"> .actions > .checkbox, > .titlebar",filter:function(t){return!s(t).closest(".tab-label").length},checkboxMode:!0});for(var h=0;h<c.length;h++){var f=s(c[h]),p=new Craft.MatrixInput.Entry(this,f);p.id&&-1!==s.inArray(""+p.id,u)&&p.collapse()}this.addListener(this.$addEntryBtn,"activate",o(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.$addEntryBtn.addClass("loading"),t.prev=1,t.next=4,this.addEntry(this.$addEntryBtn.data("type"));case 4:return t.prev=4,this.$addEntryBtn.removeClass("loading"),t.finish(4);case 7:case"end":return t.stop()}}),t,this,[[1,,4,7]])})))),this.$addEntryMenuBtn.length&&this.$addEntryMenuBtn.disclosureMenu().data("disclosureMenu").$container.find("button").on("activate",function(){var t=o(i().mark((function t(e){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a.$addEntryMenuBtn.addClass("loading"),t.prev=1,t.next=4,a.addEntry(s(e.currentTarget).data("type"));case 4:return t.prev=4,a.$addEntryMenuBtn.removeClass("loading"),t.finish(4);case 7:case"end":return t.stop()}}),t,null,[[1,,4,7]])})));return function(e){return t.apply(this,arguments)}}()),this.updateAddEntryBtn(),setTimeout((function(){a.elementEditor=a.$container.closest("form").data("elementEditor"),a.elementEditor&&a.elementEditor.on("update",(function(){a.settings.ownerId=a.elementEditor.getDraftElementId(a.settings.ownerId)})),a.trigger("afterInit")}),100)},canAddMoreEntries:function(){return!this.maxEntries||this.$entriesContainer.children().length<this.maxEntries},updateAddEntryBtn:function(){if(this.canAddMoreEntries()){this.$addEntryBtn.removeClass("disabled").removeAttr("aria-disabled"),this.$addEntryMenuBtn.removeClass("disabled");for(var t=0;t<this.entrySelect.$items.length;t++){var e=this.entrySelect.$items.eq(t).data("entry");e&&(e.$actionMenu.find("button[data-action=add]").parent().removeClass("disabled"),e.$actionMenu.find("button[data-action=add]").removeAttr("aria-disabled"))}}else{this.$addEntryBtn.addClass("disabled").attr("aria-disabled","true"),this.$addEntryMenuBtn.addClass("disabled");for(var n=0;n<this.entrySelect.$items.length;n++){var r=this.entrySelect.$items.eq(n).data("entry");r&&(r.$actionMenu.find("button[data-action=add]").parent().addClass("disabled"),r.$actionMenu.find("button[data-action=add]").attr("aria-disabled","true"))}}},updateStatusMessage:function(){var t,e=this;this.$statusMessage.empty(),this.canAddMoreEntries()||(t=Craft.t("app","Entry could not be added. Maximum number of entries reached.")),setTimeout((function(){e.$statusMessage.text(t)}),250)},addEntry:function(t,e,n){var r=this;return o(i().mark((function a(){return i().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if(r.canAddMoreEntries()){a.next=3;break}return r.updateStatusMessage(),a.abrupt("return");case 3:if(!r.elementEditor){a.next=6;break}return a.next=6,r.elementEditor.setFormValue(r.settings.baseInputName,"*");case 6:Craft.queue.push(o(i().mark((function a(){var l,d,c,u;return i().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if(!r.addingEntry){a.next=2;break}return a.abrupt("return");case 2:return r.addingEntry=!0,a.next=5,Craft.sendActionRequest("POST","matrix/create-entry",{data:{fieldId:r.settings.fieldId,entryTypeId:r.entryTypesByHandle[t].id,ownerId:r.settings.ownerId,ownerElementType:r.settings.ownerElementType,siteId:r.settings.siteId,namespace:r.settings.namespace,staticEntries:r.settings.staticEntries}});case 5:d=a.sent,c=d.data,u=s(c.blockHtml),null===(l=r.elementEditor)||void 0===l||l.pause(),e?u.insertBefore(e):u.appendTo(r.$entriesContainer),r.trigger("entryAdded",{$entry:u}),u.css(r.getHiddenEntryCss(u)).velocity({opacity:1,"margin-bottom":10},"fast",o(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return u.css("margin-bottom",""),Craft.initUiElements(u.children(".fields")),t.next=4,Craft.appendHeadHtml(c.headHtml);case 4:return t.next=6,Craft.appendBodyHtml(c.bodyHtml);case 6:new Craft.MatrixInput.Entry(r,u),r.entrySort.addItems(u),r.entrySelect.addItems(u),r.updateAddEntryBtn(),Garnish.requestAnimationFrame((function(){var t;(void 0===n||n)&&(Garnish.scrollContainerToElement(u),u.find(".flex-fields :focusable").first().focus()),null===(t=r.elementEditor)||void 0===t||t.resume()}));case 11:case"end":return t.stop()}}),t)})))),r.addingEntry=!1;case 13:case"end":return a.stop()}}),a)}))));case 7:case"end":return a.stop()}}),a)})))()},getEntryTypeByHandle:function(t){for(var e=0;e<this.entryTypes.length;e++)if(this.entryTypes[e].handle===t)return this.entryTypes[e]},collapseSelectedEntries:function(){this.callOnSelectedEntries("collapse")},expandSelectedEntries:function(){this.callOnSelectedEntries("expand")},disableSelectedEntries:function(){this.callOnSelectedEntries("disable")},enableSelectedEntries:function(){this.callOnSelectedEntries("enable")},deleteSelectedEntries:function(){this.callOnSelectedEntries("selfDestruct")},callOnSelectedEntries:function(t){for(var e=0;e<this.entrySelect.$selectedItems.length;e++)this.entrySelect.$selectedItems.eq(e).data("entry")[t]()},getHiddenEntryCss:function(t){return{opacity:0,marginBottom:-t.outerHeight()}},get maxEntries(){return this.settings.maxEntries}},{defaults:{fieldId:null,maxEntries:null,namespace:null,baseInputName:null,ownerElementType:null,ownerId:null,siteId:null,staticEntries:!1},collapsedEntryStorageKey:"Craft-"+Craft.systemUid+".MatrixInput.collapsedEntries",getCollapsedEntryIds:function(){return"string"==typeof localStorage[Craft.MatrixInput.collapsedEntryStorageKey]?Craft.filterArray(localStorage[Craft.MatrixInput.collapsedEntryStorageKey].split(",")):[]},setCollapsedEntryIds:function(t){localStorage[Craft.MatrixInput.collapsedEntryStorageKey]=t.join(",")},rememberCollapsedEntryId:function(t){if("undefined"!=typeof Storage){var e=Craft.MatrixInput.getCollapsedEntryIds();-1===s.inArray(""+t,e)&&(e.push(t),Craft.MatrixInput.setCollapsedEntryIds(e))}},forgetCollapsedEntryId:function(t){if("undefined"!=typeof Storage){var e=Craft.MatrixInput.getCollapsedEntryIds(),n=s.inArray(""+t,e);-1!==n&&(e.splice(n,1),Craft.MatrixInput.setCollapsedEntryIds(e))}},initTabs:function(t){var e=s(t).children(".pane-tabs");if(e.length){var n=new Craft.Tabs(e),r=n.$menuBtn.data("trigger");return s(r.$container).find("li, a").on("click",(function(t){t.preventDefault()})),n.on("selectTab",(function(t){var e=t.$tab.attr("href");e&&"#"===e.charAt(0)&&s(e).removeClass("hidden"),Garnish.$win.trigger("resize"),Garnish.$doc.trigger("scroll")})),n.on("deselectTab",(function(t){var e=t.$tab.attr("href");e&&"#"===e.charAt(0)&&s(t.$tab.attr("href")).addClass("hidden")})),n}}}),Craft.MatrixInput.Entry=Garnish.Base.extend({matrix:null,$container:null,$titlebar:null,$tabContainer:null,$fieldsContainer:null,$previewContainer:null,$actionMenu:null,$collapsedInput:null,tabManager:null,actionDisclosure:null,formObserver:null,visibleLayoutElements:null,cancelToken:null,ignoreFailedRequest:!1,isNew:null,id:null,collapsed:!1,init:function(t,e){var n=this;this.matrix=t,this.$container=e,this.$titlebar=e.children(".titlebar"),this.$tabContainer=this.$titlebar.children(".matrixblock-tabs"),this.$previewContainer=this.$titlebar.children(".preview"),this.$fieldsContainer=e.children(".fields"),this.$container.data("entry",this),this.id=this.$container.data("id"),this.isNew=!this.id||"string"==typeof this.id&&"new"===this.id.substring(0,3),this.$tabContainer.length&&(this.tabManager=Craft.MatrixInput.initTabs(this.$tabContainer));var r=this.$container.find("> .actions .action-btn"),i=r.data("trigger")||new Garnish.DisclosureMenu(r);this.$actionMenu=i.$container,this.actionDisclosure=i,i.on("show",(function(){n.$container.addClass("active"),n.$container.prev(".matrixblock").length?n.$actionMenu.find("button[data-action=moveUp]:first").parent().removeClass("hidden"):n.$actionMenu.find("button[data-action=moveUp]:first").parent().addClass("hidden"),n.$container.next(".matrixblock").length?n.$actionMenu.find("button[data-action=moveDown]:first").parent().removeClass("hidden"):n.$actionMenu.find("button[data-action=moveDown]:first").parent().addClass("hidden")})),i.on("hide",(function(){n.$container.removeClass("active")})),this.$actionMenuOptions=this.$actionMenu.find("button[data-action]"),this.addListener(this.$actionMenuOptions,"activate",this.handleActionClick),Garnish.hasAttr(this.$container,"data-collapsed")&&this.collapse(),this._handleTitleBarClick=function(t){s(t.target).closest(".tab-label").length||(t.preventDefault(),this.toggle())},this.addListener(this.$titlebar,"doubletap",this._handleTitleBarClick),this.visibleLayoutElements=this.$container.data("visible-layout-elements"),this.formObserver=new Craft.FormObserver(this.$container,(function(t){n.updateFieldLayout(t)}))},toggle:function(){this.collapsed?this.expand():this.collapse(!0)},collapse:function(t){var e=this;if(!this.collapsed){this.$container.addClass("collapsed");for(var n="",r=this.$fieldsContainer.children().children(),i=0;i<r.length;i++){for(var a=s(r[i]).children(".input").find('select,input[type!="hidden"],textarea,.label'),o="",l=0;l<a.length;l++){var d=s(a[l]),c=void 0;if(d.hasClass("label")){var u=d.parent().parent();if(u.hasClass("lightswitch")&&(u.hasClass("on")&&d.hasClass("off")||!u.hasClass("on")&&d.hasClass("on")))continue;c=d.text()}else c=Craft.getText(this._inputPreviewText(d));Array.isArray(c)&&(c=c.join(", ")),c&&(c=Craft.escapeHtml(c).trim())&&(o&&(o+=", "),o+=c)}o&&(n+=(n?" <span>|</span> ":"")+o)}this.$previewContainer.html(n),this.$fieldsContainer.velocity("stop"),this.$container.velocity("stop"),t&&!Garnish.prefersReducedMotion()?(this.$fieldsContainer.velocity("fadeOut",{duration:"fast"}),this.$container.velocity({height:34},"fast")):(this.$previewContainer.show(),this.$fieldsContainer.hide(),this.$container.css({height:34})),this.$tabContainer.hide(),setTimeout((function(){e.$actionMenu.find("button[data-action=collapse]:first").parent().addClass("hidden"),e.$actionMenu.find("button[data-action=expand]:first").parent().removeClass("hidden")}),200),this.isNew?this.$collapsedInput?this.$collapsedInput.val("1"):this.$collapsedInput=s('<input type="hidden" name="'+this.matrix.inputNamePrefix+"[entries]["+this.id+'][collapsed]" value="1"/>').appendTo(this.$container):Craft.MatrixInput.rememberCollapsedEntryId(this.id),this.collapsed=!0}},_inputPreviewText:function(t){if(t.is("select,multiselect")){for(var e=[],n=t.find("option:selected"),r=0;r<n.length;r++)e.push(n.eq(r).text());return e}if(t.is('input[type="checkbox"]:checked,input[type="radio"]:checked')){var i=t.attr("id"),a=s('label[for="'.concat(i,'"]'));if(a.length)return a.text()}return Garnish.getInputPostVal(t)},expand:function(){var t=this;if(this.collapsed){this.$container.removeClass("collapsed"),this.$fieldsContainer.velocity("stop"),this.$container.velocity("stop");var e=this.$container.height();this.$container.height("auto"),this.$fieldsContainer.show();var n=this.$container.height(),r=this.$fieldsContainer.css("display")||"block";this.$container.height(e),this.$fieldsContainer.hide().velocity("fadeIn",{duration:"fast",display:r});var i=Garnish.prefersReducedMotion()?0:"fast";if(this.$container.velocity({height:n},i,(function(){t.$previewContainer.html(""),t.$container.height("auto"),t.$container.trigger("scroll"),t.$tabContainer.show()})),setTimeout((function(){t.$actionMenu.find("button[data-action=collapse]:first").parent().removeClass("hidden"),t.$actionMenu.find("button[data-action=expand]:first").parent().addClass("hidden")}),200),!this.isNew&&"undefined"!=typeof Storage){var a=Craft.MatrixInput.getCollapsedEntryIds(),o=s.inArray(""+this.id,a);-1!==o&&(a.splice(o,1),Craft.MatrixInput.setCollapsedEntryIds(a))}this.isNew?this.$collapsedInput&&this.$collapsedInput.val(""):Craft.MatrixInput.forgetCollapsedEntryId(this.id),this.collapsed=!1}},disable:function(){var t=this;this.$container.children('input[name$="[enabled]"]:first').val(""),this.$container.addClass("disabled-entry"),setTimeout((function(){t.$actionMenu.find("button[data-action=disable]:first").parent().addClass("hidden"),t.$actionMenu.find("button[data-action=enable]:first").parent().removeClass("hidden")}),200),this.collapse(!0)},enable:function(){var t=this;this.$container.children('input[name$="[enabled]"]:first').val("1"),this.$container.removeClass("disabled-entry"),setTimeout((function(){t.$actionMenu.find("button[data-action=disable]:first").parent().removeClass("hidden"),t.$actionMenu.find("button[data-action=enable]:first").parent().addClass("hidden")}),200)},moveUp:function(){this.matrix.trigger("beforeMoveEntryUp",{entry:this});var t=this.$container.prev(".matrixblock");t.length&&(this.$container.insertBefore(t),this.matrix.entrySelect.resetItemOrder()),this.matrix.trigger("moveEntryUp",{entry:this})},moveDown:function(){this.matrix.trigger("beforeMoveEntryDown",{entry:this});var t=this.$container.next(".matrixblock");t.length&&(this.$container.insertAfter(t),this.matrix.entrySelect.resetItemOrder()),this.matrix.trigger("moveEntryDown",{entry:this})},handleActionClick:function(t){t.preventDefault(),this.onActionSelect(t.target)},onActionSelect:function(t){var e=this.matrix.entrySelect.totalSelected>1&&this.matrix.entrySelect.isSelected(this.$container),n=s(t);switch(n.data("action")){case"collapse":e?this.matrix.collapseSelectedEntries():this.collapse(!0);break;case"expand":e?this.matrix.expandSelectedEntries():this.expand();break;case"disable":e?this.matrix.disableSelectedEntries():this.disable();break;case"enable":e?this.matrix.enableSelectedEntries():(this.enable(),this.expand());break;case"moveUp":this.moveUp();break;case"moveDown":this.moveDown();break;case"add":var r=n.data("type");this.matrix.addEntry(r,this.$container);break;case"delete":e?confirm(Craft.t("app","Are you sure you want to delete the selected entries?"))&&this.matrix.deleteSelectedEntries():this.selfDestruct()}this.actionDisclosure.hide()},selfDestruct:function(){var t=this;s("[name]",this.$container).removeAttr("name"),this.$container.velocity(this.matrix.getHiddenEntryCss(this.$container),"fast",(function(){t.$container.remove(),t.matrix.updateAddEntryBtn(),t.matrix.trigger("entryDeleted",{$entry:t.$container})}))},updateFieldLayout:function(t){var e=this;return new Promise((function(n,i){var a,o=e.matrix.elementEditor,l=e.$container.data("base-input-name");if(null!=o&&o.submittingForm)i("Form already being submitted.");else{e.cancelToken&&(e.ignoreFailedRequest=!0,e.cancelToken.cancel());var d=function(t){return Craft.namespaceInputName(t,l)},c=r(r(r(r(r(r(r({},d("visibleLayoutElements"),e.visibleLayoutElements),d("elementType"),"craft\\elements\\Entry"),d("ownerId"),e.matrix.settings.ownerId),d("fieldId"),e.matrix.settings.fieldId),d("sortOrder"),e.$container.index()+1),d("typeId"),e.$container.data("type-id")),d("elementUid"),null!==(a=null==o?void 0:o.getDraftElementUid(e.$container.data("uid")))&&void 0!==a?a:e.$container.data("uid")),u=e.$fieldsContainer.children("[data-layout-tab]:not(.hidden)").data("id");u&&(c[d("selectedTab")]=u),t+="&".concat(s.param(c)),e.cancelToken=axios.CancelToken.source(),Craft.sendActionRequest("POST","elements/update-field-layout",{cancelToken:e.cancelToken.token,headers:{"content-type":"application/x-www-form-urlencoded","X-Craft-Namespace":l},data:t}).then((function(r){e._afterUpdateFieldLayout(t,u,l,r),n()})).catch((function(t){e.ignoreFailedRequest||i(t),e.ignoreFailedRequest=!1})).finally((function(){e.cancelToken=null}))}}))},_afterUpdateFieldLayout:function(t,n,r,a){var l=this;return o(i().mark((function t(){var o,d,c,u,h,f,p,y,m,v,g,b,$,E,C,x,w;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:d=l.$fieldsContainer.children("[data-layout-tab]:not(.hidden)").data("id"),c=s(),u={},h=e(a.data.missingElements);try{for(h.s();!(f=h.n()).done;){p=f.value,(y=l.$fieldsContainer.children('[data-layout-tab="'.concat(p.uid,'"]'))).length||(y=s("<div/>",{id:Craft.namespaceId(p.id,r),class:"flex-fields","data-id":p.id,"data-layout-tab":p.uid}),p.id!==n&&y.addClass("hidden"),y.appendTo(l.$fieldsContainer)),c=c.add(y),m=e(p.elements);try{for(m.s();!(v=m.n()).done;)!1!==(g=v.value).html?(u[p.uid]||(u[p.uid]=[]),u[p.uid].push(g.uid),"string"==typeof g.html&&(b=y.children('[data-layout-element="'.concat(g.uid,'"]')),$=s(g.html),b.length?b.replaceWith($):$.appendTo(y),Craft.initUiElements($))):(E=y.children('[data-layout-element="'.concat(g.uid,'"]'))).length&&Garnish.hasAttr(E,"data-layout-element-placeholder")||(C=s("<div/>",{class:"hidden","data-layout-element":g.uid,"data-layout-element-placeholder":""}),E.length?E.replaceWith(C):C.appendTo(y))}catch(t){m.e(t)}finally{m.f()}}}catch(t){h.e(t)}finally{h.f()}return(x=l.$fieldsContainer.children("[data-layout-tab]").not(c).not('[data-layout-tab=""]')).length&&x.remove(),c.filter(":not(.hidden)").length||c.first().removeClass("hidden"),l.visibleLayoutElements=u,l.tabManager&&(l.tabManager.destroy(),l.tabManager=null,l.$tabContainer.html("")),l.hasTabs=!!a.data.tabs,l.hasTabs&&(l.$tabContainer.append(a.data.tabs),l.tabManager=Craft.MatrixInput.initTabs(l.$tabContainer),n&&d&&n!==d&&((w=l.tabManager.$tabs.filter('[data-id="'.concat(d,'"]'))).length?l.tabManager.selectTab(w):l.tabManager.selectTab(l.tabManager.$tabs.first()))),t.next=15,Craft.appendHeadHtml(a.data.headHtml);case 15:return t.next=17,Craft.appendBodyHtml(a.data.bodyHtml);case 17:null===(o=l.matrix.elementEditor)||void 0===o||o.handleDismissibleTips();case 18:case"end":return t.stop()}}),t)})))()}})}();
//# sourceMappingURL=MatrixInput.js.map